name: User Batch Tracking Update

on:
  # æ¯Žé€±æ—¥æ›œæ—¥ã®åˆå‰10æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 10 * * 0'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      max_batches:
        description: 'Maximum number of batches to process'
        required: false
        default: '10'
        type: number

permissions:
  contents: read

concurrency:
  group: "user-batch-tracking"
  cancel-in-progress: false

jobs:
  # ã‚¹ãƒ†ãƒƒãƒ—1: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’å–å¾—ã—ã¦ãƒãƒƒãƒæ•°ã‚’æ±ºå®š
  determine-tracking-batches:
    runs-on: ubuntu-latest
    outputs:
      batch-count: ${{ steps.count.outputs.batch-count }}
      total-users: ${{ steps.count.outputs.total-users }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: Install dependencies
      run: |
        cd backend
        npm ci
        
    - name: Count active tracking users and determine batches
      id: count
      run: |
        cd backend
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚«ã‚¦ãƒ³ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œï¼ˆãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ç”¨ï¼‰
        output=$(node -e "
          import('./user-batch-tracking.js').then(async (module) => {
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã™ã‚‹éƒ¨åˆ†ã‚’å®Ÿè¡Œ
            try {
              const { db } = await import('./firebase-config.js');
              
              const usersSnapshot = await db.collection('users').get();
              let activeUsers = 0;
              
              for (const userDoc of usersSnapshot.docs) {
                try {
                  const settingsDoc = await db.collection('users').doc(userDoc.id)
                    .collection('settings').doc('config').get();
                  
                  if (settingsDoc.exists) {
                    const settings = settingsDoc.data();
                    
                    if (settings.youtubeApiKey && 
                        settings.youtubeApiKey.startsWith('AIza') && 
                        settings.youtubeApiKey.length >= 35) {
                      
                      const trackingChannels = await db.collection('users').doc(userDoc.id)
                        .collection('channels')
                        .where('status', '==', 'tracking')
                        .get();
                      
                      if (trackingChannels.docs.length > 0) {
                        activeUsers++;
                      }
                    }
                  }
                } catch (error) {
                  // å€‹åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
                }
              }
              
              const batches = Math.ceil(activeUsers / 3);
              const maxBatches = parseInt(process.env.MAX_BATCHES || '10');
              const batchCount = Math.min(batches, maxBatches);
              
              console.log(\`BATCH_COUNT=\${batchCount}\`);
              console.log(\`TOTAL_USERS=\${activeUsers}\`);
              console.log(\`ðŸ“Š ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ¦ãƒ¼ã‚¶ãƒ¼: \${activeUsers}å\`);
              console.log(\`ðŸ“Š ä½œæˆäºˆå®šãƒãƒƒãƒæ•°: \${batchCount}\`);
              
            } catch (error) {
              console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚«ã‚¦ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼:', error);
              console.log('BATCH_COUNT=0');
              console.log('TOTAL_USERS=0');
              process.exit(1);
            }
          });
        ")
        echo "$output"
        
        # çµæžœã‚’æŠ½å‡ºã—ã¦GitHub Actionsã®å‡ºåŠ›ã«è¨­å®š
        batch_count=$(echo "$output" | grep "BATCH_COUNT=" | cut -d'=' -f2)
        total_users=$(echo "$output" | grep "TOTAL_USERS=" | cut -d'=' -f2)
        
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ï¼‰
        if [ -z "$batch_count" ]; then
          batch_count=0
        fi
        if [ -z "$total_users" ]; then
          total_users=0
        fi
        
        echo "batch-count=$batch_count" >> $GITHUB_OUTPUT
        echo "total-users=$total_users" >> $GITHUB_OUTPUT
        
        echo "âœ… ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒãƒƒãƒæ•°: $batch_count, ç·ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: $total_users"
      env:
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        MAX_BATCHES: ${{ github.event.inputs.max_batches || 10 }}

  # ã‚¹ãƒ†ãƒƒãƒ—2: ãƒãƒƒãƒä¸¦åˆ—å‡¦ç†ã§ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°æ›´æ–°
  update-tracking-batches:
    runs-on: ubuntu-latest
    needs: determine-tracking-batches
    if: needs.determine-tracking-batches.outputs.batch-count > 0
    
    strategy:
      matrix:
        batch-index: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]  # æœ€å¤§10ãƒãƒƒãƒã¾ã§å¯¾å¿œ
      max-parallel: 2  # ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã¯å°‘ã—æŽ§ãˆã‚ã«ä¸¦åˆ—å®Ÿè¡Œ
      fail-fast: false  # 1ã¤ã®ãƒãƒƒãƒãŒå¤±æ•—ã—ã¦ã‚‚ä»–ã‚’ç¶™ç¶š
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: Install dependencies
      run: |
        cd backend
        npm ci
        
    - name: Check if tracking batch should run
      id: should-run
      run: |
        batch_count=${{ needs.determine-tracking-batches.outputs.batch-count }}
        current_batch=${{ matrix.batch-index }}
        
        if [ $current_batch -lt $batch_count ]; then
          echo "should_run=true" >> $GITHUB_OUTPUT
          echo "âœ… Tracking Batch $current_batch will be processed (total: $batch_count)"
        else
          echo "should_run=false" >> $GITHUB_OUTPUT
          echo "â­ï¸ Tracking Batch $current_batch skipped (total: $batch_count)"
        fi
        
    - name: Update tracking data for batch ${{ matrix.batch-index }}
      id: tracking
      if: steps.should-run.outputs.should_run == 'true'
      run: |
        cd backend
        
        echo "ðŸ“Š Processing tracking batch ${{ matrix.batch-index }}"
        
        # ãƒãƒƒãƒãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°æ›´æ–°ã‚’å®Ÿè¡Œ
        if node user-batch-tracking.js ${{ matrix.batch-index }}; then
          echo "âœ… Tracking Batch ${{ matrix.batch-index }} completed successfully"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Tracking Batch ${{ matrix.batch-index }} failed"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
      env:
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        LOG_LEVEL: info
        
    - name: Create tracking batch report
      if: always() && steps.should-run.outputs.should_run == 'true'
      run: |
        cd backend
        
        echo "Tracking Batch ${{ matrix.batch-index }} Report" > tracking-batch-${{ matrix.batch-index }}-report.txt
        echo "==============================" >> tracking-batch-${{ matrix.batch-index }}-report.txt
        echo "Execution time: $(date)" >> tracking-batch-${{ matrix.batch-index }}-report.txt
        echo "Status: ${{ steps.tracking.outputs.success == 'true' && 'SUCCESS' || 'FAILED' }}" >> tracking-batch-${{ matrix.batch-index }}-report.txt
        echo "" >> tracking-batch-${{ matrix.batch-index }}-report.txt
        echo "Tracking Statistics:" >> tracking-batch-${{ matrix.batch-index }}-report.txt
        echo "- Batch Index: ${{ matrix.batch-index }}" >> tracking-batch-${{ matrix.batch-index }}-report.txt
        echo "- Total Tracking Users: ${{ needs.determine-tracking-batches.outputs.total-users }}" >> tracking-batch-${{ matrix.batch-index }}-report.txt
        echo "- Total Batches: ${{ needs.determine-tracking-batches.outputs.batch-count }}" >> tracking-batch-${{ matrix.batch-index }}-report.txt
        
    - name: Upload tracking batch report
      if: always() && steps.should-run.outputs.should_run == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: tracking-batch-${{ matrix.batch-index }}-report
        path: backend/tracking-batch-${{ matrix.batch-index }}-report.txt
        retention-days: 7

  # ã‚¹ãƒ†ãƒƒãƒ—3: ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°çµæžœã®çµ±åˆã¨ã‚µãƒžãƒªãƒ¼
  summarize-tracking-results:
    runs-on: ubuntu-latest
    needs: [determine-tracking-batches, update-tracking-batches]
    if: always() && needs.determine-tracking-batches.outputs.batch-count > 0
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download all tracking batch reports
      uses: actions/download-artifact@v4
      with:
        path: reports/
        pattern: tracking-batch-*-report
        
    - name: Create consolidated tracking report
      run: |
        echo "ðŸ“Š User Batch Tracking Summary" > tracking-summary.txt
        echo "========================================" >> tracking-summary.txt
        echo "Execution Date: $(date)" >> tracking-summary.txt
        echo "Total Tracking Users: ${{ needs.determine-tracking-batches.outputs.total-users }}" >> tracking-summary.txt
        echo "Total Tracking Batches: ${{ needs.determine-tracking-batches.outputs.batch-count }}" >> tracking-summary.txt
        echo "" >> tracking-summary.txt
        
        # å„ãƒãƒƒãƒã®çµæžœã‚’ã¾ã¨ã‚ã‚‹
        echo "Tracking Batch Results:" >> tracking-summary.txt
        echo "---------------------" >> tracking-summary.txt
        
        successful_batches=0
        failed_batches=0
        
        for report_dir in reports/tracking-batch-*-report/; do
          if [ -d "$report_dir" ]; then
            batch_num=$(echo "$report_dir" | grep -o 'tracking-batch-[0-9]*' | grep -o '[0-9]*')
            if [ -f "$report_dir/tracking-batch-${batch_num}-report.txt" ]; then
              echo "Tracking Batch ${batch_num}:" >> tracking-summary.txt
              if grep -q "SUCCESS" "$report_dir/tracking-batch-${batch_num}-report.txt"; then
                echo "  Status: âœ… SUCCESS" >> tracking-summary.txt
                successful_batches=$((successful_batches + 1))
              else
                echo "  Status: âŒ FAILED" >> tracking-summary.txt
                failed_batches=$((failed_batches + 1))
              fi
            fi
          fi
        done
        
        echo "" >> tracking-summary.txt
        echo "Summary:" >> tracking-summary.txt
        echo "  Successful Tracking Batches: ${successful_batches}" >> tracking-summary.txt
        echo "  Failed Tracking Batches: ${failed_batches}" >> tracking-summary.txt
        
        total_processed=$((successful_batches + failed_batches))
        if [ $total_processed -gt 0 ]; then
          success_rate=$((successful_batches * 100 / total_processed))
          echo "  Success Rate: ${success_rate}%" >> tracking-summary.txt
        else
          echo "  Success Rate: 0%" >> tracking-summary.txt
        fi
        
        echo "" >> tracking-summary.txt
        echo "â„¹ï¸ Individual tracking batch reports are available as artifacts" >> tracking-summary.txt
        
        # ã‚µãƒžãƒªãƒ¼ã‚’è¡¨ç¤º
        cat tracking-summary.txt
        
    - name: Upload consolidated tracking report
      uses: actions/upload-artifact@v4
      with:
        name: tracking-summary
        path: tracking-summary.txt
        retention-days: 30